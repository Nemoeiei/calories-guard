"""
Gamification Routes\nManages achievements and gamification features\n\"\"\"\nfrom fastapi import APIRouter, HTTPException, status, Depends\nfrom app.schemas.gamification_schemas import (\n    AchievementResponse, UserAchievementResponse, GamificationStatsResponse\n)\nfrom app.crud.gamification_crud import AchievementCRUD\nfrom app.security.dependencies import get_current_user\n\nrouter = APIRouter(prefix=\"/gamification\", tags=[\"Gamification\"])\n\n@router.get(\"/achievements\", response_model=list[AchievementResponse])\nasync def get_all_achievements():\n    \"\"\"\n    Get all available achievements\n    \"\"\"\n    try:\n        achievements = AchievementCRUD.get_all_achievements()\n        return achievements\n    \n    except Exception as e:\n        raise HTTPException(\n            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,\n            detail=str(e)\n        )\n\n@router.get(\"/my-achievements\", response_model=list[UserAchievementResponse])\nasync def get_user_achievements(user_id: int = Depends(get_current_user)):\n    \"\"\"\n    Get user's earned achievements\n    Requires authentication\n    \"\"\"\n    try:\n        achievements = AchievementCRUD.get_user_achievements(user_id)\n        return achievements\n    \n    except Exception as e:\n        raise HTTPException(\n            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,\n            detail=str(e)\n        )\n\n@router.get(\"/stats\", response_model=GamificationStatsResponse)\nasync def get_gamification_stats(user_id: int = Depends(get_current_user)):\n    \"\"\"\n    Get user's gamification statistics\n    Requires authentication\n    \n    Returns:\n    - current_streak: Current consecutive login/goal streak\n    - total_achievements: Number of earned achievements\n    - total_login_days: Total days logged in\n    - achievements: List of earned achievements\n    \"\"\"\n    try:\n        stats = AchievementCRUD.get_gamification_stats(user_id)\n        \n        if not stats:\n            raise HTTPException(\n                status_code=status.HTTP_404_NOT_FOUND,\n                detail=\"User not found\"\n            )\n        \n        return stats\n    \n    except HTTPException:\n        raise\n    except Exception as e:\n        raise HTTPException(\n            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,\n            detail=str(e)\n        )\n\n@router.post(\"/check-achievements\")\nasync def check_achievements(user_id: int = Depends(get_current_user)):\n    \"\"\"\n    Check for and award new achievements\n    Requires authentication\n    \n    This endpoint evaluates:\n    - Streak achievements\n    - Meals logged achievements\n    - Goal met days achievements\n    \"\"\"\n    try:\n        awarded = []\n        \n        # Check streak achievements\n        streak_awarded = AchievementCRUD.check_and_award_streak_achievements(user_id)\n        awarded.extend(streak_awarded if isinstance(streak_awarded, list) else [])\n        \n        # Check meals logged achievements\n        meals_awarded = AchievementCRUD.check_and_award_meals_logged_achievements(user_id)\n        awarded.extend(meals_awarded if isinstance(meals_awarded, list) else [])\n        \n        # Check goal met achievements\n        goal_awarded = AchievementCRUD.check_and_award_goal_met_achievements(user_id)\n        awarded.extend(goal_awarded if isinstance(goal_awarded, list) else [])\n        \n        return {\n            \"message\": \"Achievements checked\",\n            \"newly_awarded\": len(awarded),\n            \"awards\": awarded\n        }\n    \n    except Exception as e:\n        raise HTTPException(\n            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,\n            detail=str(e)\n        )\n"
